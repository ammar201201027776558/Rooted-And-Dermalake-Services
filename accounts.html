<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</title>
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }
		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			padding: 20px;
			direction: rtl;
		}
		.container {
			max-width: 1000px;
			margin: 20px auto;
			background: #fff;
			padding: 30px;
			border-radius: 8px;
			box-shadow: 0 6px 18px rgba(0,0,0,.08);
		}
		h1 { text-align: right; margin-bottom: 30px; font-size: 2em; color: #222; }
		
		/* Summary boxes at the top */
		.summary-row {
			display: grid;
			grid-template-columns: 1fr 1fr 1fr;
			gap: 20px;
			margin-bottom: 30px;
		}
		.summary-box {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			padding: 20px;
			border-radius: 8px;
			text-align: center;
			box-shadow: 0 4px 12px rgba(0,0,0,0.15);
		}
		.summary-box .label {
			font-size: 0.9em;
			font-weight: 600;
			opacity: 0.95;
			margin-bottom: 10px;
		}
		.summary-box .value {
			font-size: 2.2em;
			font-weight: 800;
		}
		
		/* Form layout: three columns on top row, button on bottom */
		.form-group {
			display: grid;
			grid-template-columns: 1fr 1fr 1fr;
			gap: 20px;
			margin-bottom: 20px;
			align-items: flex-start;
		}
		.form-group > div {
			display: flex;
			flex-direction: column;
		}
		.form-group label { 
			font-weight: 700;
			margin-bottom: 10px;
			color: #333;
			font-size: 1em;
			text-align: right;
		}
		.form-group input {
			padding: 12px;
			border: 2px solid #999;
			border-radius: 6px;
			font-size: 1em;
			font-family: inherit;
			text-align: right;
		}
		.form-group input:focus { 
			outline: none;
			border-color: #667eea;
			box-shadow: 0 0 4px rgba(102, 126, 234, 0.3);
		}
		
		/* Header and button styles */
		.header-row { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 10px; }
		.header-actions { display: flex; gap: 10px; align-items: center; }
		.header-actions button {
			padding: 12px 25px;
			background: #667eea;
			color: white;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			font-size: 1em;
			font-weight: 600;
			transition: background 0.3s;
		}
		.header-actions button:hover { background: #5568d3; }

		/* Button in its own row */
		.button-row {
			display: flex;
			justify-content: flex-start;
			margin-bottom: 30px;
		}
		.form-group button,
		.button-row button {
			padding: 12px 28px;
			background: #667eea;
			color: white;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-weight: 700;
			font-size: 0.95em;
		}
		.form-group button:hover,
		.button-row button:hover { background: #5568d3; }
		
		.table-wrapper { overflow-x: auto; margin-top: 30px; }
		table {
			width: 100%;
			border-collapse: collapse;
		}
		thead { background: #667eea; color: white; }
		th {
			padding: 12px;
			text-align: right;
			font-weight: 600;
			font-size: 1em;
		}
		td {
			padding: 12px;
			border-bottom: 1px solid #ddd;
			text-align: right;
		}
		tbody tr:hover { background: #f5f5f5; }
		tbody tr:nth-child(even) { background: #fafafa; }
		.delete-btn {
			background: #e74c3c !important;
			padding: 6px 10px !important;
			font-size: 0.85em !important;
			cursor: pointer;
			border: none !important;
			color: white !important;
			border-radius: 4px !important;
		}
		.delete-btn:hover { background: #c0392b !important; }
		.empty-message { text-align: center; color: #999; padding: 30px; font-size: 1em; }
		.back-btn {
			background: #34495e;
			color: #fff;
			padding: 12px 20px;
			border: 0;
			border-radius: 6px;
			cursor: pointer;
			margin-top: 20px;
			font-weight: 700;
			font-size: 1em;
			transition: opacity 0.3s;
		}
		.back-btn:hover { opacity: 0.9; }
	</style>
</head>
<body>
	<div class="container">
		<div class="header-row">
			<h1>ğŸ“Š Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h1>
			<div class="header-actions">
				<button onclick="downloadCSV()">Downlod</button>
				<button onclick="document.getElementById('uploadFile').click()">Upload</button>
				<input type="file" id="uploadFile" accept=".csv,text/csv" style="display:none" onchange="handleUploadFile(event)">
			</div>
		</div>

			<!-- Authentication / user controls -->
			<div id="authArea" style="display:flex; gap:8px; justify-content:flex-start; align-items:center; margin:14px 0;">
				<div id="authStatus" style="font-weight:700; color:#222;">ØºÙŠØ± Ù…Ø³Ø¬Ù„</div>
				<button id="openAuthBtn" onclick="openAuthPanel()" style="padding:8px 12px;background:#667eea;color:#fff;border-radius:5px;border:none;">ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„</button>
				<button id="logoutBtn" onclick="handleLogout()" style="display:none;padding:8px 12px;background:#e74c3c;color:#fff;border-radius:5px;border:none;">Ø®Ø±ÙˆØ¬</button>
				<button id="saveProgressBtn" style="padding:8px 12px;background:#27ae60;color:#fff;border-radius:5px;border:none;">Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…</button>
				<button id="loadProgressBtn" style="padding:8px 12px;background:#34495e;color:#fff;border-radius:5px;border:none;">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…</button>
			</div>

		<!-- Summary boxes -->
		<div class="summary-row">
			<div class="summary-box">
				<div class="label">Ø§Ù„Ø®Ø²Ù†Ø©</div>
				<div id="totalCash" class="value">0.00</div>
			</div>
			<div class="summary-box">
				<div class="label">Ø§Ù„Ø®Ø§Ø±Ø¬ Ù…Ù† Ø§Ù„Ø®Ø²Ù†Ø©</div>
				<div id="totalExpenses" class="value">0.00</div>
			</div>
			<div class="summary-box">
				<div class="label">Ø§Ù„ØªØ­ØµÙŠÙ„</div>
				<div id="totalCollection" class="value">0.00</div>
			</div>
		</div>

		<!-- Input Form -->
		<div class="form-group">
			<div>
				<label for="expense">Ø§Ù„Ø®Ø§Ø±Ø¬ Ù…Ù† Ø§Ù„Ø®Ø²Ù†Ø©</label>
				<input type="text" id="expense" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†">
			</div>
			<div>
				<label for="amount">Ø§Ù„Ù…Ø¨Ù„Øº</label>
				<input type="number" id="amount" placeholder="0" min="0">
			</div>
			<div>
				<label for="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
				<input type="date" id="date">
			</div>
		</div>
		
		<!-- Add Button -->
		<div class="button-row">
			<button onclick="addEntry()">Ø¥Ø¶Ø§ÙØ©</button>
		</div>

		<!-- Data Table -->
		<div class="table-wrapper">
			<table id="accountsTable">
				<thead>
					<tr>
						<th>Ø§Ù„Ø®Ø§Ø±Ø¬ Ù…Ù† Ø§Ù„Ø®Ø²Ù†Ø©</th>
						<th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
						<th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
						<th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
					</tr>
				</thead>
				<tbody id="tableBody">
				</tbody>
			</table>
			<div id="emptyMessage" class="empty-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</div>
		</div>

		<div class="nav-buttons" style="display:flex; gap:10px; margin-top:20px;">
			<button class="back-btn" onclick="window.location.href='index.html'" style="background:#667eea;">ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª</button>
			<button class="back-btn" onclick="window.location.href='accounts.html'" style="background:#34495e; opacity:0.6;">ğŸ“Š Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</button>
			<button class="back-btn" onclick="window.location.href='products.html'" style="background:#27ae60;">ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
		</div>
	</div>

	<script>
		function updateSummary() {
			const entries = loadEntries();
			const totalExpenses = entries.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
			
			// Get Ø§Ù„ØªØ­ØµÙŠÙ„ (collection) total from index.html pharmacies data
			const pharamcyData = JSON.parse(localStorage.getItem('pharmacies') || '[]');
			const totalCollection = pharamcyData.reduce((sum, p) => sum + (parseFloat(p.collection) || 0), 0);
			
			// Calculate Ø§Ù„Ø®Ø²Ù†Ø© = Ø§Ù„ØªØ­ØµÙŠÙ„ - Ø§Ù„Ø®Ø§Ø±Ø¬ Ù…Ù† Ø§Ù„Ø®Ø²Ù†Ø©
			const totalCash = totalCollection - totalExpenses;
			
			document.getElementById('totalCash').textContent = totalCash.toFixed(2);
			document.getElementById('totalExpenses').textContent = totalExpenses.toFixed(2);
			document.getElementById('totalCollection').textContent = totalCollection.toFixed(2);
		}

		function loadEntries() {
			const saved = localStorage.getItem('accountsEntries');
			return saved ? JSON.parse(saved) : [];
		}

		function saveEntries(entries) {
			localStorage.setItem('accountsEntries', JSON.stringify(entries));
		}

		function addEntry() {
			const expense = document.getElementById('expense').value.trim();
			const amount = document.getElementById('amount').value.trim();
			const date = document.getElementById('date').value;

			if (!expense || !amount || !date) {
				alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
				return;
			}

			const entries = loadEntries();
			const newEntry = {
				id: Date.now(),
				expense: expense,
				amount: parseFloat(amount),
				date: date
			};

			entries.push(newEntry);
			saveEntries(entries);

			document.getElementById('expense').value = '';
			document.getElementById('amount').value = '';
			document.getElementById('date').value = '';

			updateSummary();
			renderTable();
		}

		function deleteEntry(id) {
			if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯ØŸ')) {
				const entries = loadEntries();
				const filtered = entries.filter(e => e.id !== id);
				saveEntries(filtered);
				updateSummary();
				renderTable();
			}
		}

		function renderTable() {
			const entries = loadEntries();
			const tableBody = document.getElementById('tableBody');
			const emptyMessage = document.getElementById('emptyMessage');

			tableBody.innerHTML = '';

			if (entries.length === 0) {
				emptyMessage.style.display = 'block';
				document.getElementById('accountsTable').style.display = 'none';
				return;
			}

			emptyMessage.style.display = 'none';
			document.getElementById('accountsTable').style.display = 'table';

			entries.forEach(entry => {
				const row = document.createElement('tr');
				row.innerHTML = `
					<td>${entry.expense}</td>
					<td>${entry.amount.toFixed(2)}</td>
					<td>${entry.date}</td>
					<td><button class="delete-btn" onclick="deleteEntry(${entry.id})">Ø­Ø°Ù</button></td>
				`;
				tableBody.appendChild(row);
			});
		}

		// Initial render

		function downloadCSV() {
			const entries = loadEntries();
			if (!entries.length) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªÙ†Ø²ÙŠÙ„'); return; }
			const headers = ['Ø§Ù„Ø®Ø§Ø±Ø¬ Ù…Ù† Ø§Ù„Ø®Ø²Ù†Ø©','Ø§Ù„Ù…Ø¨Ù„Øº','Ø§Ù„ØªØ§Ø±ÙŠØ®'];
			const rows = entries.map(e => [e.expense, (parseFloat(e.amount)||0).toFixed(2), e.date]);
			const lines = [headers, ...rows].map(r => r.map(cell => {
				if (cell === null || cell === undefined) return '';
				const s = String(cell).replace(/"/g, '""');
				return `"${s}"`;
			}).join(','));
			const csvContent = '\uFEFF' + lines.join('\r\n');
			const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = 'accounts_entries.csv';
			document.body.appendChild(a);
			a.click();
			a.remove();
			URL.revokeObjectURL(url);
		}


		// CSV download (keeps previous implementation)
		function downloadCSV() {
			const entries = loadEntries();
			if (!entries.length) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªÙ†Ø²ÙŠÙ„'); return; }
			const headers = ['Ø§Ù„Ø®Ø§Ø±Ø¬ Ù…Ù† Ø§Ù„Ø®Ø²Ù†Ø©','Ø§Ù„Ù…Ø¨Ù„Øº','Ø§Ù„ØªØ§Ø±ÙŠØ®'];
			const rows = entries.map(e => [e.expense, (parseFloat(e.amount)||0).toFixed(2), e.date]);
			const lines = [headers, ...rows].map(r => r.map(cell => {
				if (cell === null || cell === undefined) return '';
				const s = String(cell).replace(/"/g, '""');
				return `"${s}"`;
			}).join(','));
			const csvContent = '\uFEFF' + lines.join('\r\n');
			const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = 'accounts_entries.csv';
			document.body.appendChild(a);
			a.click();
			a.remove();
			URL.revokeObjectURL(url);
		}

		function handleUploadFile(event) {
			const file = event.target.files && event.target.files[0];
			if (!file) return;
			const reader = new FileReader();
			reader.onload = function(e) {
				try {
					let text = e.target.result;
					// remove BOM
					text = text.replace(/\uFEFF/g, '');
					const rows = parseCSV(text);
					if (!rows || rows.length < 2) throw new Error('Ù…Ù„Ù CSV ÙØ§Ø±Øº Ø£Ùˆ Ø¨ØªÙ†Ø³ÙŠÙ‚ ØºÙŠØ± ØµØ§Ù„Ø­');
					const headers = rows[0].map(h => h.trim());
					const expenseIdx = findHeaderIndex(headers, ['Ø®Ø§Ø±Ø¬','Ø§Ù„Ø®Ø§Ø±Ø¬','expense','description']);
					const amountIdx = findHeaderIndex(headers, ['Ù…Ø¨Ù„Øº','Ø§Ù„Ù…Ø¨Ù„Øº','amount']);
					const dateIdx = findHeaderIndex(headers, ['ØªØ§Ø±ÙŠØ®','date']);
					if (expenseIdx === -1 || amountIdx === -1 || dateIdx === -1) throw new Error('ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: Ø§Ù„Ø®Ø§Ø±Ø¬ Ù…Ù† Ø§Ù„Ø®Ø²Ù†Ø©, Ø§Ù„Ù…Ø¨Ù„Øº, Ø§Ù„ØªØ§Ø±ÙŠØ®');
					const data = rows.slice(1).map(r => ({
						id: Date.now() + Math.floor(Math.random()*1000),
						expense: (r[expenseIdx]||'').trim(),
						amount: parseFloat((r[amountIdx]||'').replace(/[^0-9.-]/g,'')) || 0,
						date: (r[dateIdx]||'').trim()
					}));
					if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…ÙØ­Ù…Ù„ØŸ')) return;
					saveEntries(data);
					updateSummary();
					renderTable();
					alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
				} catch (err) {
					alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­: ' + err.message);
				} finally {
					event.target.value = '';
				}
			};
			reader.readAsText(file, 'utf-8');
		}

		function findHeaderIndex(headers, patterns) {
			for (let i=0;i<headers.length;i++) {
				const h = headers[i].toLowerCase();
				for (const p of patterns) if (h.indexOf(p) !== -1) return i;
			}
			return -1;
		}

		function parseCSV(text) {
			const rows = [];
			let cur = '';
			let row = [];
			let inQuotes = false;
			for (let i=0;i<text.length;i++) {
				const ch = text[i];
				const next = text[i+1];
				if (ch === '"') {
					if (inQuotes && next === '"') { cur += '"'; i++; }
					else { inQuotes = !inQuotes; }
				} else if (ch === ',' && !inQuotes) {
					row.push(cur); cur = '';
				} else if ((ch === '\n' || ch === '\r') && !inQuotes) {
					if (ch === '\r' && next === '\n') { /* skip, will handle on \n */ }
					if (cur !== '' || row.length) { row.push(cur); rows.push(row); row = []; cur = ''; }
				} else {
					cur += ch;
				}
			}
			if (inQuotes) throw new Error('ØªÙ†Ø³ÙŠÙ‚ CSV: Ù‚ÙˆØ³ Ø§Ù‚ØªØ¨Ø§Ø³ ØºÙŠØ± Ù…ØªÙˆØ§Ø²Ù†');
			if (cur !== '' || row.length) { row.push(cur); rows.push(row); }
			// Trim whitespace from cells
			return rows.map(r => r.map(c => (c||'').trim()));
		}

		updateSummary();
		renderTable();
	</script>

	<script src="auth.js"></script>
	<script>
		function openAuthPanel(){
			const username = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:');
			if(username===null) return;
			const password = prompt('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:');
			if(password===null) return;
			const isRegister = confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ØŸ Ø§Ø¶ØºØ· Ù…ÙˆØ§ÙÙ‚ Ù„Ù„ØªØ³Ø¬ÙŠÙ„ØŒ Ø¥Ù„ØºØ§Ø¡ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
			if(isRegister){
				const r = auth.registerUser(username,password);
				if(!r.ok) alert(r.msg); else alert('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ Ùƒ ' + username);
			} else {
				const r = auth.loginUser(username,password);
				if(!r.ok) alert(r.msg); else alert('ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ùƒ ' + username);
			}
			updateAuthUI();
		}

		function handleLogout(){ auth.logoutUser(); updateAuthUI(); alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); }

		function updateAuthUI(){
			const u = auth.getCurrentUser();
			document.getElementById('authStatus').textContent = u ? 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: '+u : 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
			document.getElementById('logoutBtn').style.display = u ? 'inline-block' : 'none';
			document.getElementById('openAuthBtn').style.display = u ? 'none' : 'inline-block';
		}

		document.getElementById('saveProgressBtn').addEventListener('click', function(){
			const u = auth.getCurrentUser(); if(!u){ alert('Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'); return; }
			const state = {
				pharmacies: JSON.parse(localStorage.getItem('pharmacies') || '[]'),
				accountsEntries: JSON.parse(localStorage.getItem('accountsEntries') || '[]'),
				products: JSON.parse(localStorage.getItem('products') || '[]'),
				productStocks: JSON.parse(localStorage.getItem('productStocks') || '{}')
			};
			const res = auth.saveUserProgress(state);
			if(res.ok) alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…'); else alert(res.msg);
		});

		document.getElementById('loadProgressBtn').addEventListener('click', function(){
			const u = auth.getCurrentUser(); if(!u){ alert('Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'); return; }
			const state = auth.loadUserProgress();
			if(!state){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…'); return; }
			if(state.pharmacies) localStorage.setItem('pharmacies', JSON.stringify(state.pharmacies));
			if(state.accountsEntries) localStorage.setItem('accountsEntries', JSON.stringify(state.accountsEntries));
			if(state.products) localStorage.setItem('products', JSON.stringify(state.products));
			if(state.productStocks) localStorage.setItem('productStocks', JSON.stringify(state.productStocks));
			alert('ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…. Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¥Ù† Ù„Ø²Ù…'); location.reload();
		});

		updateAuthUI();
	</script>
</body>
</html>
