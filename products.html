<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }
		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			padding: 20px;
			direction: rtl;
		}
		.container {
			max-width: 1200px;
			margin: 20px auto;
			background: #fff;
			padding: 30px;
			border-radius: 8px;
			box-shadow: 0 6px 18px rgba(0,0,0,.08);
		}
		h1 { 
			text-align: right; 
			margin-bottom: 30px; 
			font-size: 2em; 
			color: #222; 
		}
		
		/* Products grid - up to 3 columns */
		.products-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
			gap: 20px;
			margin-bottom: 30px;
		}
		
		.product-box {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			padding: 25px;
			border-radius: 8px;
			box-shadow: 0 4px 12px rgba(0,0,0,0.15);
			text-align: center;
			transition: transform 0.3s ease, box-shadow 0.3s ease;
		}
		
		.product-box:hover {
			transform: translateY(-5px);
			box-shadow: 0 6px 18px rgba(0,0,0,0.25);
		}
		
		.product-box .name {
			font-size: 1.3em;
			font-weight: 700;
			margin-bottom: 15px;
			word-break: break-word;
		}
		
		.product-box .product-info {
			display: grid;
			grid-template-columns: 1fr;
			gap: 15px;
			margin-top: 15px;
		}
		
		.product-box .info-row {
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 6px;
		}
		
		.product-box .info-label {
			font-size: 0.85em;
			font-weight: 600;
			opacity: 0.9;
		}
		
		.product-box .info-value {
			font-size: 1.8em;
			font-weight: 700;
		}
		
		.product-box input[type="number"] {
			width: 80%;
			padding: 8px;
			font-size: 1.2em;
			border: none;
			border-radius: 4px;
			text-align: center;
			font-weight: 700;
		}
		
		.product-box input[type="number"]::placeholder {
			opacity: 0.6;
		}
		
		.product-box .total {
			font-size: 1.3em;
			font-weight: 800;
			margin-bottom: 10px;
		}
		
		.product-box .label {
			font-size: 0.95em;
			font-weight: 600;
			opacity: 0.95;
		}
		
		.empty-message { 
			text-align: center; 
			color: #999; 
			padding: 40px; 
			font-size: 1.1em; 
		}
		
		.back-btn {
			background: #34495e;
			color: #fff;
			padding: 12px 20px;
			border: 0;
			border-radius: 6px;
			cursor: pointer;
			margin-top: 20px;
			font-weight: 700;
			font-size: 1em;
			transition: opacity 0.3s;
		}
		
		.back-btn:hover { 
			opacity: 0.9; 
		}
		
		@media (max-width: 768px) {
			.products-grid {
				grid-template-columns: 1fr;
			}
			
			.product-box .total {
				font-size: 2em;
			}
			
			h1 {
				font-size: 1.5em;
			}
		}
	</style>
</head>
<body>
	<div class="container">
		<!-- Authentication controls -->
		<div id="authArea" style="position:absolute; top:20px; right:30px; display:flex; gap:8px; align-items:center; z-index:900;">
			<div id="authStatus" style="font-weight:700; color:#fff; background:rgba(0,0,0,0.2); padding:6px 10px; border-radius:6px;">ØºÙŠØ± Ù…Ø³Ø¬Ù„</div>
			<button id="openAuthBtn" onclick="openAuthPanel()" style="padding:6px 10px; background:#667eea; color:#fff; border-radius:6px; border:none;">ØªØ³Ø¬ÙŠÙ„/Ø¯Ø®ÙˆÙ„</button>
			<button id="logoutBtn" onclick="handleLogout()" style="display:none;padding:6px 10px; background:#e74c3c; color:#fff; border-radius:6px; border:none;">Ø®Ø±ÙˆØ¬</button>
			<button id="saveProgressBtn" style="padding:6px 10px; background:#27ae60; color:#fff; border-radius:6px; border:none;">Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…</button>
			<button id="loadProgressBtn" style="padding:6px 10px; background:#34495e; color:#fff; border-radius:6px; border:none;">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…</button>
		</div>
		<h1>ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h1>

		<!-- Products grid -->
		<div id="productsContainer" class="products-grid">
		</div>
		
		<div id="emptyMessage" class="empty-message">
			Ù„Ù… ØªØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯
		</div>

		<div class="nav-buttons" style="display:flex; gap:10px; margin-top:20px;">
			<button class="back-btn" onclick="window.location.href='index.html'" style="background:#667eea;">ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª</button>
			<button class="back-btn" onclick="window.location.href='accounts.html'" style="background:#27ae60;">ğŸ“Š Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</button>
			<button class="back-btn" onclick="window.location.href='products.html'" style="background:#34495e; opacity:0.6;">ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
		</div>
	</div>

	<script>
		function loadData() {
			const saved = localStorage.getItem('pharmacies');
			return saved ? JSON.parse(saved) : [];
		}

		function loadProducts() {
			const saved = localStorage.getItem('products');
			return saved ? JSON.parse(saved) : [];
		}

		function loadProductStocks() {
			const saved = localStorage.getItem('productStocks');
			return saved ? JSON.parse(saved) : {};
		}

		function saveProductStocks(stocks) {
			localStorage.setItem('productStocks', JSON.stringify(stocks));
		}

		function updateOriginalStock(product, value) {
			const stocks = loadProductStocks();
			const numValue = parseInt(value, 10) || 0;
			stocks[product] = Math.max(0, numValue);
			saveProductStocks(stocks);
			renderProducts();
		}

		function renderProducts() {
			const products = loadProducts();
			const data = loadData();
			const stocks = loadProductStocks();
			const container = document.getElementById('productsContainer');
			const emptyMessage = document.getElementById('emptyMessage');

			container.innerHTML = '';

			if (products.length === 0) {
				emptyMessage.style.display = 'block';
				return;
			}

			emptyMessage.style.display = 'none';

			// Calculate totals for each product
			const totals = {};
			products.forEach(p => totals[p] = 0);

			data.forEach(entry => {
				(entry.products || []).forEach(pr => {
					const name = (typeof pr === 'object') ? pr.name : pr;
					const qty = (typeof pr === 'object') ? (parseInt(pr.qty, 10) || 0) : 1;
					if (!name) return;
					if (!totals[name]) totals[name] = 0;
					totals[name] += qty;
				});
			});

			// Create product boxes
			products.forEach(product => {
				const originalStock = stocks[product] || 0;
				const used = totals[product] || 0;
				const remaining = Math.max(0, originalStock - used);
				
				const box = document.createElement('div');
				box.className = 'product-box';
				box.innerHTML = `
					<div class="name">${product}</div>
					<div class="product-info">
						<div class="info-row">
							<div class="info-label">Ø£ØµÙ„ Ø§Ù„Ø§Ø³ØªÙˆÙƒ</div>
							<input type="number" min="0" value="${originalStock}" placeholder="0" onchange="updateOriginalStock('${product.replace(/'/g, "\\'")}', this.value)" onkeyup="this.onchange()">
						</div>
						<div class="info-row">
							<div class="info-label">Ø§Ù„Ø®Ø§Ø±Ø¬ Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù†</div>
							<div class="info-value">${used}</div>
						</div>
						<div class="info-row">
							<div class="info-label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
							<div class="info-value">${remaining}</div>
						</div>
					</div>
				`;
				container.appendChild(box);
			});
		}

		// Initial render
		renderProducts();

		// Re-render when localStorage changes (from other tabs or index.html)
		window.addEventListener('storage', renderProducts);
	</script>

	<script src="auth.js"></script>
	<script>
		async function openAuthPanel(){
			const username = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:'); if(username===null) return;
			const password = prompt('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:'); if(password===null) return;
			const isRegister = confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ØŸ Ù…ÙˆØ§ÙÙ‚=ØªØ³Ø¬ÙŠÙ„ØŒ Ø¥Ù„ØºØ§Ø¡=ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„');
			if(isRegister){ const r = await auth.registerUser(username,password); if(!r.ok) alert(r.msg || 'Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„'); else alert('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ Ùƒ ' + username); }
			else { const r = await auth.loginUser(username,password); if(!r.ok) alert(r.msg || 'Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); else alert('ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ùƒ ' + username); }
			updateAuthUI();
		}
		function handleLogout(){ auth.logoutUser(); updateAuthUI(); alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); }
		function updateAuthUI(){ const u = auth.getCurrentUser(); const el = document.getElementById('authStatus'); if(el) el.textContent = u ? 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: '+u : 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'; document.getElementById('logoutBtn').style.display = u ? 'inline-block' : 'none'; document.getElementById('openAuthBtn').style.display = u ? 'none' : 'inline-block'; }
		document.getElementById('saveProgressBtn').addEventListener('click', async function(){ const u = auth.getCurrentUser(); if(!u){ alert('Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'); return; } const state = { products: JSON.parse(localStorage.getItem('products')||'[]'), productStocks: JSON.parse(localStorage.getItem('productStocks')||'{}'), pharmacies: JSON.parse(localStorage.getItem('pharmacies')||'[]') }; const res = await auth.saveUserProgress(state); if(res.ok) alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…'); else alert(res.msg || 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸'); });
		document.getElementById('loadProgressBtn').addEventListener('click', async function(){ const u = auth.getCurrentUser(); if(!u){ alert('Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'); return; } const state = await auth.loadUserProgress(); if(!state){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©'); return; } if(state.products) localStorage.setItem('products', JSON.stringify(state.products)); if(state.productStocks) localStorage.setItem('productStocks', JSON.stringify(state.productStocks)); if(state.pharmacies) localStorage.setItem('pharmacies', JSON.stringify(state.pharmacies)); alert('ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…. Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¥Ù† Ù„Ø²Ù…'); location.reload(); });
		updateAuthUI();
	</script>
</body>
</html>
